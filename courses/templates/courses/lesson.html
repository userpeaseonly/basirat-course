{% extends "base.html" %}
{% load i18n %}
{% block title %}{{ lesson.title }} — {{ course.title }}{% endblock %}
{% block content %}
<div class="container mx-auto py-10">
    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 space-y-6">
        <div class="flex flex-col gap-2">
            <a href="{% url 'course_detail' course.slug %}" class="text-sm text-slate-500 font-semibold">← {% trans "Back to course" %}</a>
            <h1 class="text-3xl font-bold text-slate-900">{{ lesson.title }}</h1>
            <p class="text-sm text-slate-500">{% trans "Lesson" %} {{ lesson.order|add:1 }} • {{ lesson.description|default:_('No description yet.') }}</p>
        </div>
        <div class="space-y-5">
            {% for data in material_data %}
                {% with material=data.material %}
                <article class="border rounded-2xl p-4 bg-slate-50">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <h2 class="text-xl font-semibold text-slate-900">{{ material.title }}</h2>
                            <p class="text-sm text-slate-500">
                                {% if material.material_type == material.LEARNING %}
                                    {% trans "Learning resource" %}
                                {% else %}
                                    {% trans "Task" %}
                                    {% if material.question_type == 'single_choice' %}({% trans "Single choice" %})
                                    {% elif material.question_type == 'multiple_choice' %}({% trans "Multiple choice" %})
                                    {% elif material.question_type == 'free_response' %}({% trans "Free response" %})
                                    {% endif %}
                                {% endif %}
                            </p>
                        </div>
                        {% if data.completed %}
                            <span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold">{% trans "Completed" %}</span>
                        {% endif %}
                    </div>
                    <div class="mt-3 text-slate-700 space-y-3 text-sm select-none" oncontextmenu="return false;">
                        {% if material.content %}
                            <p class="whitespace-pre-line">{{ material.content }}</p>
                        {% endif %}
                        {% if material.media_file %}
                            <div class="rounded-2xl bg-black/80 p-2">
                                <video
                                    controls
                                    playsinline
                                    disablepictureinpicture
                                    disableRemotePlayback
                                    controlsList="nodownload nofullscreen noremoteplayback"
                                    oncontextmenu="return false;"
                                    class="w-full rounded-xl bg-black"
                                >
                                    <source src="{{ material.media_file.url }}">
                                    {% trans "Your browser does not support inline video playback." %}
                                </video>
                            </div>
                        {% endif %}
                    </div>
                    {% if material.is_protected %}
                        <p class="text-xs text-slate-500 mt-4">{% trans "Downloads and copy-pastes are disabled for protected materials." %}</p>
                    {% endif %}
                    
                    {% if material.material_type == material.TASK %}
                        {# Task submission interface #}
                        <div class="mt-4 space-y-3">
                            {% if data.latest_submission %}
                                <div class="bg-white border rounded-lg p-3 text-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-semibold">{% trans "Latest Attempt" %} #{{ data.latest_submission.attempt_number }}</span>
                                        {% if data.latest_submission.status == 'graded' %}
                                            {% if data.latest_submission.is_passing %}
                                                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-semibold">{% trans "Passed" %}: {{ data.latest_submission.score|floatformat:0 }}%</span>
                                            {% else %}
                                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold">{% trans "Failed" %}: {{ data.latest_submission.score|floatformat:0 }}%</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold">{% trans "Pending Review" %}</span>
                                        {% endif %}
                                    </div>
                                    {% if data.latest_submission.feedback %}
                                        <p class="text-slate-600 mt-2"><strong>{% trans "Feedback" %}:</strong> {{ data.latest_submission.feedback }}</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            {% if not data.completed %}
                                {% if data.can_submit %}
                                    <a href="{% url 'task_submit' material.id %}" class="inline-block px-4 py-2 text-sm rounded-full bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">
                                        {% if data.attempts_used > 0 %}
                                            {% trans "Try Again" %} ({{ data.attempts_used }}/3)
                                        {% else %}
                                            {% trans "Submit Answer" %}
                                        {% endif %}
                                    </a>
                                {% else %}
                                    <p class="text-sm text-red-600 font-semibold">{% trans "All 3 attempts used. Contact instructor for help." %}</p>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% else %}
                        {# Learning material completion button #}
                        {% if not data.completed %}
                            <form method="post" action="{% url 'material_complete' material.id %}" class="mt-3">
                                {% csrf_token %}
                                <button type="submit" class="px-4 py-2 text-sm rounded-full bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">{% trans "Mark as completed" %}</button>
                            </form>
                        {% endif %}
                    {% endif %}
                </article>
                {% endwith %}
            {% empty %}
                <p class="text-sm text-slate-500">{% trans "No materials have been added yet." %}</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
